# ADR 001: 마이크로서비스 아키텍처 도입

## 상태

승인됨 (Accepted)

## 컨텍스트

Orai는 기업용 사내 메신저 및 협업 시스템으로, 다음과 같은 핵심 기능을 제공합니다:

- 사용자 인증 및 관리
- 실시간 채팅
- 일정 관리
- 푸시 알림

초기에는 모놀리식 아키텍처로 시작할 수 있었으나, 다음과 같은 요구사항이 있었습니다:

1. **독립적 배포**: 각 기능의 독립적인 배포 및 스케일링
2. **기술 다양성**: 채팅은 MongoDB, 사용자는 MySQL 등 기능별 최적화된 기술 스택 사용
3. **팀 분리 개발**: 기능별 팀이 독립적으로 개발 가능
4. **장애 격리**: 한 서비스의 장애가 전체 시스템에 영향을 주지 않도록

## 결정

**Spring Cloud 기반 마이크로서비스 아키텍처를 도입합니다.**

### 서비스 구성

```
┌─────────────────────────────────────────────────────────────────┐
│                        Client (Web/Mobile)                       │
└────────────────────────────────┬────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Gateway Service (8080)                       │
│                    - 라우팅, JWT 검증, CORS                       │
└────────────────────────────────┬────────────────────────────────┘
                                 │
        ┌────────────────────────┼────────────────────────┐
        ▼                        ▼                        ▼
┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│ User Service  │      │ Chat Service  │      │Calendar Service│
│    (8081)     │      │    (8084)     │      │    (8082)     │
│   - 인증/MFA   │      │  - 실시간 채팅  │      │   - 일정 관리   │
│   - 사용자관리  │      │  - WebSocket  │      │   - 부서 관리   │
└───────┬───────┘      └───────┬───────┘      └───────┬───────┘
        │                      │                      │
        ▼                      ▼                      ▼
    [MySQL]              [MongoDB]               [MySQL]
    [Redis]              [MySQL]                 [Redis]
                         [Redis]

┌───────────────┐
│ Etc Service   │ ◄── Redis Pub/Sub
│    (8083)     │
│  - 푸시 알림   │
│  - SSE        │
└───────────────┘
```

### 인프라 서비스

| 서비스 | 포트 | 역할 |
|--------|------|------|
| Discovery Service | 8761 | Eureka 서비스 레지스트리 |
| Config Service | 8888 | 중앙 설정 관리 |
| Gateway Service | 8080 | API 게이트웨이 |

### 선택한 기술

| 컴포넌트 | 기술 | 이유 |
|----------|------|------|
| 서비스 디스커버리 | Netflix Eureka | Spring Cloud와 네이티브 통합, 자가 치유 기능 |
| 설정 관리 | Spring Cloud Config | Git 기반 버전 관리, 동적 설정 갱신 |
| API 게이트웨이 | Spring Cloud Gateway | WebFlux 기반 비동기 처리, 필터 체인 |
| 서비스 간 통신 | OpenFeign | 선언적 HTTP 클라이언트, 로드밸런싱 내장 |

## 대안 검토

### 1. 모놀리식 아키텍처

**장점**:
- 단순한 배포 및 운영
- 트랜잭션 관리 용이
- 초기 개발 속도 빠름

**단점**:
- 스케일링의 유연성 부족
- 기술 스택 변경 어려움
- 코드베이스 복잡도 증가

### 2. Kubernetes 네이티브 서비스 디스커버리

**장점**:
- Eureka 없이 K8s DNS 활용
- 인프라 단순화

**단점**:
- K8s 환경 필수
- Spring Cloud 생태계와의 통합 추가 작업 필요

## 결과

### 긍정적 결과

1. **독립적 배포**: 각 서비스별 CI/CD 파이프라인 구축
2. **기술 최적화**: chat-service는 MongoDB, user-service는 MySQL 사용
3. **장애 격리**: user-service 장애 시에도 기존 채팅 세션 유지
4. **스케일링**: chat-service만 별도 스케일아웃 가능

### 부정적 결과 (Trade-offs)

1. **운영 복잡도 증가**: 7개 서비스 모니터링 및 관리 필요
2. **분산 트랜잭션**: 서비스 간 데이터 일관성 관리 복잡
3. **네트워크 레이턴시**: 서비스 간 HTTP 호출로 인한 지연
4. **디버깅 어려움**: 분산 환경에서의 로그 추적 필요

### 완화 전략

- **분산 추적**: Spring Cloud Sleuth + Zipkin 도입 예정
- **Circuit Breaker**: Resilience4j로 장애 전파 방지
- **중앙 로깅**: ELK Stack 구축

## 참조

- [Spring Cloud Documentation](https://spring.io/projects/spring-cloud)
- [Netflix OSS](https://netflix.github.io/)
- [Microservices Patterns by Chris Richardson](https://microservices.io/patterns/)
